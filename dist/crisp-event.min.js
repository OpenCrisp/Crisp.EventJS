/*! OpenCrisp EventJS - v0.1.0 - 2015-07-09
* https://github.com/OpenCrisp/Crisp.EventJS
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(a){return void 0!==a?k(a,"RegExp")?a:new RegExp("^"+j(a)+"\\.?"):void 0}function c(a){return void 0!==a?k(a,"RegExp")?a:new RegExp("^"+j(a)+"$"):void 0}function d(){this.list={}}function e(a,b,c,e,f){this.action=a,this.treat=b,this.self=c,this.path=e,this.picker=f,this.wait=1,this.repeat=!0,this.note=new d}function f(a){this.listen=a.listen,this.self=a.self,this.async=a.async,this.action=b(a.action),this.path=c(a.path),this.noteAction=b(a.noteAction),this.notePath=c(a.notePath),this.noteList=a.noteList||h}function g(){this.listener=[]}var h="own",i=a.utilTick,j=a.escapeRegExp,k=a.isType;d.prototype={List:function(a){return a=a||h,this.list[a]=this.list[a]||[]},Length:function(a){var b,c=0;if(void 0!==a);else for(b in this.list)c+=this.list[b].length;return c},Empty:function(a){return 0===this.Length(a)},Add:function(a,b){this.List(a.type||b).push(a)}},e.prototype={Wait:function(){return this.wait+=1,this},Talk:function(){this.wait-=1,this.wait>0||this.note.Empty()||(delete this.picker[this.treat],this.self.eventTrigger(this))},Note:function(a,b){return this.note.Add(a,b),this}},f.prototype={talk:function(a){var b=this;if(b.self!==a.exporter&&!(b.action&&!b.action.test(a.action)||b.path&&!b.path.test(a.path))){if(b.notePath||b.noteAction){var c=0;if(a.note.list[b.noteList].forEach(function(a){var d=0;b.notePath&&!b.notePath.test(a.path)&&(d+=1),b.noteAction&&!b.noteAction.test(a.action)&&(d+=1),0===d&&(c+=1)}),0===c)return}a.async=a.async||b.async,i(b.self,b.listen,a)}},is:function(a){var c;return c=this.action&&a.action?this.action.toString()===b(a.action).toString():void 0===this.action||void 0===a.action,this.listen===a.listen&&c}},g.prototype={add:function(a){for(var b,c=this.listener,d=0,e=c.length;e>d;d+=1)if(c[d].is(a))return c[d];return b=new f(a),c.push(b),b},trigger:function(a){for(var b=this.listener,c=0,d=b.length;d>c;c+=1)b[c].talk(a);return this},remove:function(a){for(var b=this.listener,c=0,d=b.length;d>c;c+=1)if(b[c]===a){b.splice(c,1);break}return this}},a.defineEvent=function(a){return Object.defineProperties(a,{__event__:{writabel:!0,value:new g},eventListener:{value:function(a){return a.self=a.self||this,this.__event__.add(a)}},eventTrigger:{value:function(a){return this.__event__.trigger(a),this}},eventPicker:{value:function(a){var b,c,d,f;return c=a.cache.picker=a.cache.picker||{},b=a.action||"task",d=b.split(".")[0],c[d]instanceof e?c[d].Wait():(f=a.self||this,c[d]=new e(b,d,f,a.path,c))}},eventRemove:{value:function(a){return a}}}),a}}(Crisp);