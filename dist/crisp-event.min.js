/*! OpenCrisp EventJS - v0.5.1 - 2016-10-07
* https://github.com/OpenCrisp/Crisp.EventJS
* Copyright (c) 2016 Fabian Schmid; Licensed [object Object] */
!function(a){function b(a){var b;if(void 0!==a)return w.call(a,"RegExp")?a:(b=a.split(" "),b.map(function(a){return v(a)}),new RegExp("(^|\\s)("+b.join("|")+")($|\\s|\\.)"))}function c(a){var b;if(void 0!==a)return w.call(a,"RegExp")?a:(b=a.split(" "),b.map(function(a){return v(a)}),new RegExp("^("+b.join("|")+")$"))}function d(){this._list={}}function e(a,b,c,e,f,g){this.self=a,this.action=c,this.path=f,this.repeat=!0,this.picker=b,this._treat=e,this._empty=g,this._wait=1,this._note=new d}function f(a){this._listen=a.listen,this._self=a.self,this._async=a.async,this._action=b(a.action),this._path=c(a.path),this._noteAction=b(a.noteAction),this._notePath=c(a.notePath),this._noteList=a.noteList||z}function g(){this._listener=[]}function h(a){return a=a||{},a.event=a.event||B,a.parent=a.parent||C,a}function i(a,b){return b=h(b),a.hasOwnProperty(b.event)&&a[b.event]instanceof g}function j(a,b){return a.self=a.self||this,b.add(a)}function k(a,b,c){return a=a||{},a.self=a.self||this,b.trigger(a),a.repeat&&c&&w.call(c.eventTrigger,"Function")&&c.eventTrigger(a),this}function l(a){var b,c,d;return c=a.cache.picker=a.cache.picker||{},b=a.action||A,d=b.split(".")[0],c[d]instanceof e?c[d].Wait():(!a.path&&w.call(this.docPath,"Function")&&(a.path=this.docPath()),c[d]=new e(this,c,b,d,a.path,a.empty))}function m(a,b){return b.remove(a),this}function n(a,b){var c,d;if(!a||!i(a))return this;c=a._("event")._listener;for(var e=0,f=c.length;e<f;e+=1)d=c[e],d._self===a&&(d._self=this),b._listener.push(d);return this}function o(a,b){return b=h(b),Object.defineProperty(a,b.event,{writabel:!0,value:new g}),Object.defineProperties(a,{eventListener:{value:function(a){return j.call(this,a,this[b.event])}},eventTrigger:{value:function(a){return k.call(this,a,this[b.event],this[b.parent])}},eventPicker:{value:l},eventRemove:{value:function(a){return m.call(this,a,this[b.event])}},eventResettle:{value:function(a){return n.call(this,a,this[b.event])}}}),a}function p(a,b,c,d,e){a.call(b,c,d,e),e.Talk()}function q(b,c){function d(c,d,e){var f,g={};return d=d||y,a.defineEvent(g),e&&g.eventListener({self:this,listen:e}),f=g.eventPicker({cache:{},empty:!0}),c.async?t(p,b,this,c,d,f):(b.call(this,c,d,f),f.Talk()),this}return Object.defineProperty(d,"tick",{value:c||!0}),Object.defineProperty(d,"callback",{value:b}),d}function r(a,b,c,d,e){function f(a){if(a instanceof x)throw g.End(),h.End(),a;b.eventTrigger(a),g.Note(a),h.Note(a)}var g,h;g=b.eventPicker({cache:c,action:"task.doc."+e}),h=b.eventPicker({cache:c,action:"changed.doc."+e}),a.call(b,c,d,f),g.Talk(),h.Talk()}function s(a,b,c){function d(c,d){var e;return d=d||y,c.async&&(e=c.async,delete c.async),e?t(r,a,this,c,d,b):r(a,this,c,d,b),this}return Object.defineProperty(d,"task",{value:c||!0}),Object.defineProperty(d,"callback",{value:a}),d}var t=a.nextTick,u=a.utilTick,v=RegExp.escape,w=a.type,x=a.ns("util.control.Break"),y=a.ns("util.control.Noop"),z="own",A="task",B="__event__",C="__parent__";d.prototype={List:function(a){return a=a||z,this._list[a]=this._list[a]||[]},Length:function(a){var b,c=0;if(void 0!==a);else for(b in this._list)c+=this._list[b].length;return c},Empty:function(a){return 0===this.Length(a)},Add:function(a,b){this.List(a.type||b).push(a)}},e.prototype={Wait:function(){return this._wait+=1,this},Talk:function(){return this._wait-=1,this._wait>0||!this._empty&&this._note.Empty()?this:this.End()},End:function(){return this._wait=0,delete this.picker[this._treat],this.self.eventTrigger(this),this},Note:function(a,b){return this._note.Add(a,b),this},List:function(a){return this._note.List(a)},Test:function(a){var b=0;return this._note.List(a._noteList).forEach(function(c){var d=0;a._notePath&&!a._notePath.test(c.path)&&(d+=1),a._noteAction&&!a._noteAction.test(c.action)&&(d+=1),0===d&&(b+=1)}),0===b}},f.prototype={talk:function(a){this._self!==a.exporter&&(this._action&&!this._action.test(a.action)||this._path&&!this._path.test(a.path)||(!this._notePath&&!this._noteAction||a instanceof e&&!a.Test(this))&&u(this._self,this._listen,a,this._async))},is:function(a){var c;return c=this._action&&a.action?this._action.toString()===b(a.action).toString():void 0===this._action||void 0===a.action,this._listen===a.listen&&c}},g.prototype={add:function(a){for(var b,c=this._listener,d=0,e=c.length;d<e;d+=1)if(c[d].is(a))return c[d];return b=new f(a),c.push(b),b},trigger:function(a){for(var b=this._listener,c=0,d=b.length;c<d;c+=1)b[c].talk(a);return this},remove:function(a){for(var b=this._listener,c=0,d=b.length;c<d;c+=1)if(b[c]===a){b.splice(c,1);break}return this}},a.hasOwnEvent=i;var D={name:"event",preset:function(){return new g},insert:!0},E={name:"parent",preset:{}},F={proWri:!0};a.ns("util.event").options={event:F},a.ns("util.event").prototypes={eventListener:function(a){return j.call(this,a,this._(D))},eventTrigger:function(a){return k.call(this,a,this._(D),this._(E))},eventPicker:l,eventRemove:function(a){return m.call(this,a,this._(D))},eventResettle:function(a){return n.call(this,a,this._(D))}},a.defineEvent=o,a.utilPick=q,a.utilTask=s}(Crisp);