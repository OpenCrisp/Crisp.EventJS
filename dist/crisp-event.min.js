/*! OpenCrisp EventJS - v0.5.2 - 2017-07-01
* https://github.com/OpenCrisp/Crisp.EventJS
* Copyright (c) 2017 Fabian Schmid; Licensed [object Object] */

!function(t){function e(t){var e;if(void 0!==t)return y.call(t,"RegExp")?t:((e=t.split(" ")).map(function(t){return k(t)}),new RegExp("(^|\\s)("+e.join("|")+")($|\\s|\\.)"))}function n(t){var e;if(void 0!==t)return y.call(t,"RegExp")?t:((e=t.split(" ")).map(function(t){return k(t)}),new RegExp("^("+e.join("|")+")$"))}function i(){this._list={}}function s(t,e,n,s,r,o){this.self=t,this.action=n,this.path=r,this.repeat=!0,this.picker=e,this._treat=s,this._empty=o,this._wait=1,this._note=new i}function r(t){this._listen=t.listen,this._self=t.self,this._async=t.async,this._action=e(t.action),this._path=n(t.path),this._noteAction=e(t.noteAction),this._notePath=n(t.notePath),this._noteList=t.noteList||T}function o(){this._listener=[]}function c(t){return t=t||{},t.event=t.event||m,t.parent=t.parent||L,t}function a(t,e){return e=c(e),t.hasOwnProperty(e.event)&&t[e.event]instanceof o}function h(t,e){return t.self=t.self||this,e.add(t)}function u(t,e,n){return t=t||{},t.self=t.self||this,e.trigger(t),t.repeat&&n&&y.call(n.eventTrigger,"Function")&&n.eventTrigger(t),this}function l(t){var e,n,i;return n=t.cache.picker=t.cache.picker||{},e=t.action||E,i=e.split(".")[0],n[i]instanceof s?n[i].Wait():(!t.path&&y.call(this.docPath,"Function")&&(t.path=this.docPath()),n[i]=new s(this,n,e,i,t.path,t.empty))}function f(t,e){return e.remove(t),this}function v(t,e){var n,i;if(!t||!a(t))return this;for(var s=0,r=(n=t._("event")._listener).length;s<r;s+=1)(i=n[s])._self===t&&(i._self=this),e._listener.push(i);return this}function p(t,e,n,i,s){t.call(e,n,i,s),s.Talk()}function _(t,e,n,i,s){var r,o;r=e.eventPicker({cache:n,action:"task.doc."+s}),o=e.eventPicker({cache:n,action:"changed.doc."+s}),t.call(e,n,i,function(t){if(t instanceof P)throw r.End(),o.End(),t;e.eventTrigger(t),r.Note(t),o.Note(t)}),r.Talk(),o.Talk()}var d=t.nextTick,g=t.utilTick,k=RegExp.escape,y=t.type,P=t.ns("util.control.Break"),w=t.ns("util.control.Noop"),T="own",E="task",m="__event__",L="__parent__";i.prototype={List:function(t){return t=t||T,this._list[t]=this._list[t]||[]},Length:function(t){var e,n=0;if(void 0!==t);else for(e in this._list)n+=this._list[e].length;return n},Empty:function(t){return 0===this.Length(t)},Add:function(t,e){this.List(t.type||e).push(t)}},s.prototype={Wait:function(){return this._wait+=1,this},Talk:function(){return this._wait-=1,this._wait>0||!this._empty&&this._note.Empty()?this:this.End()},End:function(){return this._wait=0,delete this.picker[this._treat],this.self.eventTrigger(this),this},Note:function(t,e){return this._note.Add(t,e),this},List:function(t){return this._note.List(t)},Test:function(t){var e=0;return this._note.List(t._noteList).forEach(function(n){var i=0;t._notePath&&!t._notePath.test(n.path)&&(i+=1),t._noteAction&&!t._noteAction.test(n.action)&&(i+=1),0===i&&(e+=1)}),0===e}},r.prototype={talk:function(t){this._self!==t.exporter&&(this._action&&!this._action.test(t.action)||this._path&&!this._path.test(t.path)||(!this._notePath&&!this._noteAction||t instanceof s&&!t.Test(this))&&g(this._self,this._listen,t,this._async))},is:function(t){var n;return n=this._action&&t.action?this._action.toString()===e(t.action).toString():void 0===this._action||void 0===t.action,this._listen===t.listen&&n}},o.prototype={add:function(t){for(var e,n=this._listener,i=0,s=n.length;i<s;i+=1)if(n[i].is(t))return n[i];return e=new r(t),n.push(e),e},trigger:function(t){for(var e=this._listener,n=0,i=e.length;n<i;n+=1)e[n].talk(t);return this},remove:function(t){for(var e=this._listener,n=0,i=e.length;n<i;n+=1)if(e[n]===t){e.splice(n,1);break}return this}},t.hasOwnEvent=a;var b={name:"event",preset:function(){return new o},insert:!0},R={name:"parent",preset:{}},j={proWri:!0};t.ns("util.event").options={event:j},t.ns("util.event").prototypes={eventListener:function(t){return h.call(this,t,this._(b))},eventTrigger:function(t){return u.call(this,t,this._(b),this._(R))},eventPicker:l,eventRemove:function(t){return f.call(this,t,this._(b))},eventResettle:function(t){return v.call(this,t,this._(b))}},t.defineEvent=function(t,e){return e=c(e),Object.defineProperty(t,e.event,{writabel:!0,value:new o}),Object.defineProperties(t,{eventListener:{value:function(t){return h.call(this,t,this[e.event])}},eventTrigger:{value:function(t){return u.call(this,t,this[e.event],this[e.parent])}},eventPicker:{value:l},eventRemove:{value:function(t){return f.call(this,t,this[e.event])}},eventResettle:{value:function(t){return v.call(this,t,this[e.event])}}}),t},t.utilPick=function(e,n){function i(n,i,s){var r,o={};return i=i||w,t.defineEvent(o),s&&o.eventListener({self:this,listen:s}),r=o.eventPicker({cache:{},empty:!0}),n.async?d(p,e,this,n,i,r):(e.call(this,n,i,r),r.Talk()),this}return Object.defineProperty(i,"tick",{value:n||!0}),Object.defineProperty(i,"callback",{value:e}),i},t.utilTask=function(t,e,n){function i(n,i){var s;return i=i||w,n.async&&(s=n.async,delete n.async),s?d(_,t,this,n,i,e):_(t,this,n,i,e),this}return Object.defineProperty(i,"task",{value:n||!0}),Object.defineProperty(i,"callback",{value:t}),i}}(Crisp);